<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Clients</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<style>
:root {
  --bg-light: #222222;
  --primary: #d99e45;
  --text-primary: #ffffff;
  --max-width-post: 489px;
  --preview-size: 128px;
  --preview-border: 2px solid var(--primary);
}

html, body {
  overflow-x: hidden;
  overflow-y: auto;
  margin:0; padding:0;
  font-family: "Montserrat", sans-serif;
  background-color: var(--bg-light);
  color: var(--text-primary);
}

body {
  display: flex;
  justify-content: center;
  align-items: flex-start;
  flex-direction: column;
  padding:20px 0;
}

/* Upload Section */
.upload-section {
  width: 60%;
  max-width: var(--max-width-post);
  background:#333333;
  border:1px solid var(--primary);
  border-radius:20px;
  padding:16px;
  margin:20px auto;
  box-shadow:0 4px 10px rgba(0,0,0,0.5);
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
}

.upload-section input[type="file"] { display:none; }

.upload-icon {
  background: linear-gradient(135deg, #f99e45, #d96e25);
  width:70px; height:70px;
  border-radius:50%;
  display:flex;
  justify-content:center;
  align-items:center;
  cursor:pointer;
  margin-bottom:12px;
  box-shadow:0 4px 10px rgba(0,0,0,0.4);
  transition: transform 0.2s;
}
.upload-icon:hover { transform: scale(1.1); }
.upload-icon svg { width:35px; height:35px; stroke:#fff; fill:none; }

#preview {
  width: var(--preview-size);
  height: var(--preview-size);
  border: var(--preview-border);
  object-fit: cover;
  display: none;
  border-radius: 8px;
  margin-bottom: 8px;
}

.upload-section input[type="text"] {
  width: 90%;
  padding:10px;
  margin-bottom:12px;
  border-radius:8px;
  border:1px solid var(--primary);
  text-align:center;
  display:none;
  background:#2b2b2b;
  color: var(--text-primary);
}

.upload-section button {
  width:90%;
  padding:10px;
  background-color: var(--primary);
  color:#fff;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
}
.upload-section button:disabled {
  background-color:#f99e45;
  cursor:not-allowed;
}

/* Feed Instagram */
.instagram {
  width:99%;
  max-width: var(--max-width-post);
  background-color: #333333;
  border:1px solid var(--primary);
  border-radius:20px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  box-shadow:0 4px 10px rgba(0,0,0,0.5);
  margin-bottom:20px;
  color: var(--text-primary);
}

.instagram__header {
  display:flex;
  align-items:center;
  padding:12px 16px;
  border-bottom:1px solid var(--primary);
}
.instagram__header img {
  width:42px; height:42px;
  border-radius:50%;
  margin-right:8px;
  object-fit:cover;
  border:1px solid var(--primary);
}
.instagram__header .name { font-weight:bold; flex-grow:1; }

.instagram__media {
  width:100%;
  display:flex;
  justify-content:center;
  align-items:center;
  position:relative;
}
.instagram__media img { width:100%; height:auto; border-radius:0; }
.instagram__id {
  position:absolute;
  bottom:5px; left:50%;
  transform:translateX(-50%);
  font-size:10%;
  color:#fff;
  opacity:0.03; /* 3% */
  background: rgba(0,0,0,0.3);
  padding:2px 4px;
  border-radius:3px;
}

.instagram__buttons {
  display:flex;
  justify-content:center;
  align-items:center;
  padding:12px 16px;
}
.instagram__buttons svg {
  width:24px;
  height:24px;
  stroke: var(--primary);
  fill:none;
  margin:0 8px;
}

/* Loading overlay */
#loadingOverlay {
  position: fixed; top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.7);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:1000;
  display:none;
  flex-direction:column;
}
#loadingOverlay .spinner {
  width:80px; height:80px;
  border:8px solid #f3f3f3;
  border-top:8px solid var(--primary);
  border-radius:50%;
  animation: spin 1s linear infinite;
  margin-bottom:12px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Success / error message bubble */
#statusMsg {
  position: fixed;
  top: 20px; left:50%;
  transform: translateX(-50%);
  background:#d99e45;
  color:#fff;
  padding:12px 20px;
  border-radius:10px;
  font-weight:bold;
  display:none;
  z-index:1001;
}
#statusMsg.error { background:#e53935; }
#feed {
  display: grid;
  grid-template-columns: 1fr; /* افتراضي موبايل: بوست واحد */
  gap: 20px; /* المسافة بين البوستات */
  justify-items: center;
}

/* شاشات أكبر من 768px (اللابتوب) */
@media (min-width: 768px) {
  #feed {
    grid-template-columns: repeat(3, 1fr); /* 3 بوستات بالصف */
  }
  @media (min-width: 768px) {
  #feed {
    grid-template-columns: repeat(3, 1fr);
    max-width: 1500px;  /* عرض 3 بوستات + فراغ */
    margin: 0 auto;     /* يوسّط البوستات */
  }
  }
</style>
</head>
<body>

<!-- Upload Section -->
<div class="upload-section">
  <label class="upload-icon" id="uploadBtn">
    <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"></path></svg>
  </label>
  <input type="file" id="file" accept="image/*">
  <img id="preview" src="">
  <input type="text" id="name" placeholder="@اسمك الكامل">
  <button id="postBtn" disabled onclick="uploadPost()">Post</button>
</div>

<div id="feed"></div>

<!-- Loading overlay -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  <div>Uploading...</div>
</div>

<div id="statusMsg"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBTIpMiqs7wL1dgt6CoL-U_k1HhydpCksU",
  authDomain: "josephahmarhair.firebaseapp.com",
  projectId: "josephahmarhair",
  appId: "1:68489781737:web:73a0c1ea95cfd08ad6eb78"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const uploadBtn = document.getElementById("uploadBtn");
const fileInput = document.getElementById("file");
const preview = document.getElementById("preview");
const nameInput = document.getElementById("name");
const postBtn = document.getElementById("postBtn");

// افتح الملف مباشرة والسلوك الطبيعي للجهاز
uploadBtn.addEventListener("click", ()=>{
  fileInput.click();
});

fileInput.addEventListener("change", e => {
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = function(ev){
      preview.src = ev.target.result;
      preview.style.display = "block";
      nameInput.style.display = "block";
      checkReady();
    };
    reader.readAsDataURL(file);
  }
});

nameInput.addEventListener("input", checkReady);
function checkReady(){ 
  postBtn.disabled = !(fileInput.files.length>0 && nameInput.value.trim().length>0); 
}

function showLoading(show=true){
  document.getElementById("loadingOverlay").style.display = show?"flex":"none";
}
function showStatus(msg, success=true){
  const el = document.getElementById("statusMsg");
  el.textContent = msg;
  el.className = success?"":"error";
  el.style.display = "block";
  setTimeout(()=>{ el.style.display="none"; },2000);
}

// ضغط الصورة وتحويلها إلى JPEG
async function compressImage(file, maxWidth=1024, quality=0.7) {
  return new Promise((resolve, reject)=>{
    const img = new Image();
    img.onload = ()=>{
      const canvas = document.createElement("canvas");
      const scale = Math.min(maxWidth / img.width, 1);
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob=>{
        const reader = new FileReader();
        reader.onload = ()=>resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      }, "image/jpeg", quality);
    };
    img.onerror = reject;
    img.src = URL.createObjectURL(file);
  });
}

// رفع الصورة مع ضغط تلقائي
async function uploadPost(){
  const file = fileInput.files[0];
  const name = nameInput.value.trim();
  if(!file || !name) return;

  if(file.size > 10*1024*1024){ // حد أقصى 10MB قبل الضغط
    showStatus("حجم الصورة كبير جدًا، سيتم ضغطها تلقائياً", false);
  }

  showLoading(true);

  try{
    const base64 = await compressImage(file, 1024, 0.7); // ضغط الصورة

    await db.collection("posts").add({
      name,
      image: base64,
      approved:true,
      created: Date.now()
    });

    showLoading(false);
    showStatus("تم رفع الصورة بنجاح!",true);

    preview.src = "";
    preview.style.display="none";
    fileInput.value="";
    nameInput.value="";
    nameInput.style.display="none";
    postBtn.disabled=true;

  } catch(err){
    showLoading(false);
    showStatus("فشل الرفع، جرب مرة أخرى",false);
    console.error(err);
  }
}

// عرض البوستات
const feedContainer = document.getElementById("feed");
db.collection("posts").orderBy("created","desc").onSnapshot(snapshot=>{
  feedContainer.innerHTML="";
  snapshot.forEach(doc=>{
    const data = doc.data();
    const post = document.createElement("article");
    post.className="instagram";
    post.innerHTML = `
      <header class="instagram__header">
        <img src="https://raw.githubusercontent.com/elieahmar2/Josephejajahshzheha.github.io/refs/heads/main/logorels.jpg" alt="">
        <div class="name">${data.name}</div>
      </header>
      <section class="instagram__media">
        <img src="${data.image}" alt="">
        <div class="instagram__id">${doc.id}</div>
      </section>
      <footer class="instagram__buttons">
        <svg viewBox="0 0 24 24"><path d="M16 8.5C16 5.5 12 2.5 12 2.5S8 5.5 8 8.5C8 12 12 16 12 16S16 12 16 8.5Z"></path></svg>
        <svg viewBox="0 0 24 24"><path d="M3 3L21 3L12 21L3 3Z"></path></svg>
      </footer>
    `;
    feedContainer.appendChild(post);
  });
});
</script>

</body>
</html>
